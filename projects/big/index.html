<!DOCTYPE html>
<html>
   <head>
      <title>Big Project</title>
      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
      <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.css" rel="stylesheet">
      <link rel="stylesheet" href="css/style.css">
   </head>
   <body>
      <header class="mdc-top-app-bar">
         <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
               <a href="#" class="material-icons mdc-top-app-bar__navigation-icon menu-burger">menu</a>
               <span class="mdc-top-app-bar__title">Where do you want to live?</span>
            </section>
         </div>
      </header>
      <aside class="mdc-drawer mdc-drawer--temporary mdc-typography" data-mdc-auto-init="MDCTemporaryDrawer">
         <nav class="mdc-drawer__drawer">
            <header class="mdc-drawer__header">
               <div class="mdc-drawer__header-content">
                  Options
               </div>
            </header>
            <nav id="icon-with-text-demo" class="mdc-drawer__content mdc-list">
               <a class="mdc-list-item mdc-list-item--activated" href="#one">
               <i class="material-icons mdc-list-item__graphic" aria-hidden="true"></i>Home
               </a>
               <a class="mdc-list-item" href="#two">
               <i class="material-icons mdc-list-item__graphic" aria-hidden="true"></i>Searched
               </a>
               <a class="mdc-list-item" href="#three">
               <i class="material-icons mdc-list-item__graphic" aria-hidden="true"></i>Your List
               </a>
               <a class="mdc-list-item" href="#four">
               <i class="material-icons mdc-list-item__graphic" aria-hidden="true"></i>Graph
               </a>
            </nav>
         </nav>
      </aside>
      <!-- screen 1 s1 -->
      <div id="one" class="screen">
         <section class="hero">
            <div class="mdc-card demo-card screen-card">
               <a class="mdc-card__primary-action" href="#">
                  <div class="demo-card__primary">
                     <h2 class="demo-card__title mdc-typography--title" > An app to show information about the location.</h2>
                  </div>
                  <div class="demo-card__secondary mdc-typography--body1">
                     Search by any option and see the housing price and weather!
                  </div>
               </a>
               <img src="image/good2.jpg" class="home-image">
               <div id="city-tf"class="mdc-text-field nav center-item" data-mdc-auto-init="MDCTextField">
                  <input type="text" id="my-text-field" class="mdc-text-field__input">
                  <label class="mdc-floating-label" for="my-text-field">City*</label>
                  <div class="mdc-line-ripple"></div>
               </div>
               <div id="state-country-tf" class="mdc-text-field nav center-item" data-mdc-auto-init="MDCTextField">
                  <input type="text" id="my-text-field" class="mdc-text-field__input" >
                  <label class="mdc-floating-label" for="my-text-field" >State/Country</label>
                  <div class="mdc-line-ripple"></div>
               </div>
               <button class="mdc-button center-item" id="home-search">
               Search
               </button>
            </div>
      </div>
      </section>
      </div>
      <!-- screen 2 s2 Searched-->
      <div id="two" class="screen">

      </div>
      <!-- screen 3 s3 Your List -->
      <div id="three" class="screen">
      </div>
      
       <!-- screen 4 s4 Your List -->
      <div id="four" class="screen">
          <div id="table_div"></div>
      </div>
      
      
      
      
      <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
      <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.js"></script>
      
      
      <script type="text/javascript">
      google.charts.load('current', {'packages':['table']});
      google.charts.setOnLoadCallback(graphBasedOnData);            
            

      // indexeddb ------------------------------------------------------------------------------------------------------------------
        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
 
        if (!window.indexedDB) {
            window.alert("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
        }

        var db;
        var request = window.indexedDB.open("UserData", 1);
        
        request.onerror = function(e){
            console("on error: " + e.target.errorCode);
        }
       
        request.onsuccess = function(e){
            db = request.result;
            console.log("success:" + db);
        }     
        
        request.onupgradeneeded = function(e){
            var db = e.target.result;
            var objectStore = db.createObjectStore("cityName", {keyPath: "cityName", autoIncrement: true});
            
        }           

      
         $(document).ready(function(){
         // show the home screen
         $("#one").show();
         $("#two").hide();
         $("#three").hide();
         $("#four").hide();
         
         // when a nav link is clicked, hide screens then show target
         
         $(".menu-burger").on("click", function(){
             document.querySelector(".mdc-drawer--temporary").MDCTemporaryDrawer.open = true;  
         });
         
         
         $("nav a").on("click", function() {
         $(".screen").hide();
         var targetSelector = $(this).attr("href");
         $(targetSelector).show();
         document.querySelector(".mdc-drawer--temporary").MDCTemporaryDrawer.open = false; 
         document.querySelector('#city-tf').MDCTextField.value = "";
         document.querySelector('#state-country-tf').MDCTextField.value = "";
         if(targetSelector =='#three'){
             listCurList();
         }
         if(targetSelector =='#four'){
             graphBasedOnData();
         }
         });
         });
         
         
         function listCurList(){
            db = request.result;
            console.log("success:" + db);

            console.log("attempting to log");
            var db = request.result;
            var objectStore = db.transaction("cityName").objectStore("cityName");
            
            objectStore.openCursor().onsuccess = function(e){
                var cursor = e.target.result;
                
                if(cursor){
                    cursor.continue();
                    
                }else{
                    console.log("end of db");
                }
            }
 
         }

         function graphBasedOnData(){
             clearBox('table_div');
            db = request.result;
            var dataSet = [];
              console.log("attempting to log");
            var data = new google.visualization.DataTable();
            
            data.addColumn('string', 'City');
            data.addColumn('string', 'State');
            data.addColumn('number', 'Weather' + ascii(176) + 'C');
            data.addColumn('string', 'Date');
            data.addColumn('string', 'Description');

            var db = request.result;
            var objectStore = db.transaction("cityName").objectStore("cityName");
            objectStore.openCursor().onsuccess = function(e){
                var cursor = e.target.result;
                                  
                if(cursor){
                    /*
                    console.log( cursor.key+
                                 cursor.value.stateCountryName,+
                                 cursor.value.temp + ascii(176) + "C"+
                                 cursor.value.date+
                                 cursor.value.desc);
                                 */
                    var temp = [cursor.key, 
                                cursor.value.stateCountryName, 
                                cursor.value.temp,
                                cursor.value.date,
                                cursor.value.desc];   
                                
                    
                    cursor.continue();
                    dataSet.push(temp);
                }else{
                    console.log("end of db" );
                }
                
            }
            
setTimeout(function()
{
            var dd = dataSet;
            data.addRows(dd);
        var table = new google.visualization.Table(document.getElementById('table_div'));

        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
}, 100);            
/*
            console.log("dataSet");
            console.log(dataSet);
*/
             
             
         }
         
         
         
         function getWeatherAndJoke(){
             
             clearBox('two');
             var city, state;
             var joke;
             city = document.querySelector('#city-tf').MDCTextField.value;
             state = document.querySelector('#state-country-tf').MDCTextField.value; 
             request = window.indexedDB.open("UserData", 1);

            
            $.ajax({
              type: "GET",
              url: "https://icanhazdadjoke.com",
              success: function(data) {
                joke = data.joke;
                
              },
              dataType: "json"
            });
         
         
             var req = new XMLHttpRequest();
             req.open('GET', 'https://api.weatherbit.io/v2.0/current?city=' + city + ',' + state + '&key=a708d5fe9c2141f493b8be489740df84');
             req.onload = function(){
                 var curWeather = JSON.parse(req.responseText);
                
                $("#two").append(
                 '<section class="hero">' +
                    '<div class="mdc-card demo-card screen-card">' +
                       '<a class="mdc-card__primary-action" href="#">' +
                          '<div class="demo-card__primary">' +
                             '<h2 class="demo-card__title mdc-typography--title">' + curWeather.data[0].city_name + ', ' + curWeather.data[0].state_code  +  '</h2>' +
                             '<h3 class="demo-card__subtitle mdc-typography--subheading1">' + curWeather.data[0].datetime + '</h3>'+
                             '<h3 class="demo-card__subtitle mdc-typography--subheading1">' + curWeather.data[0].weather.description + '</h3>'+
                             '<h3 class="demo-card__subtitle mdc-typography--subheading1">' + curWeather.data[0].temp + ascii(176) + 'C</h3>'+
                             '<h3 class="demo-card__subtitle mdc-typography--subheading1">Joke of the search:</h3>'+
                             '<h3 class="demo-card__subtitle mdc-typography--subheading1">' + joke + '</h3>'+    
                            '<div id="hero-js-select" class="mdc-select">' +
                              '<select class="mdc-select__native-control">' +
                                '<option value="yes-no-funny" selected>Yes or No</option>' +
                                '<option value="yes-funny">Yes</option>' +
                                '<option value="no-funny">No</option>' +
                              '</select>' +
                              '<div class="mdc-select__label mdc-select__label--float-above">Funny?</div>' +
                              '<div class="mdc-select__bottom-line"></div>' +
                            '</div>' +                             
                          '</div>'+
                       '</a>'+
                       '<div class="mdc-card__actions">'+
                          '<div class="mdc-card__action-buttons">'+
                             '<button class="mdc-button mdc-card__action mdc-card__action--button" id="testing123">Add</button>'+
                          '</div>'+
                       '</div>'+
                    '</div>'+
                 '</section>'
                    );

            db = request.result;
                    var addReq = db.transaction(["cityName"], "readwrite").
                                objectStore("cityName").
                                add({ cityName: curWeather.data[0].city_name, 
                        stateCountryName: curWeather.data[0].state_code, 
                        date: curWeather.data[0].datetime,
                        desc: curWeather.data[0].weather.description,
                        temp:curWeather.data[0].temp,
                        jokeText: joke, 
                        funny:true
                        });
                        
                    addReq.onsuccess = function(e){
                        console.log("add success " + e);
                    }
                    
                    addReq.onerror = function(e){
                        console.log("add fail " + e);
                    }

            
             }


         $("#one").hide();
         $("#two").show();
         $("#three").hide();
             req.send();
         }
         window.onload = function() {
             
         document.getElementById("home-search").onclick = function fun() {
         getWeatherAndJoke();
         
         //validation code to see State field is mandatory.  
         }
         }
         
         // use a708d5fe9c2141f493b8be489740df84 - https://www.weatherbit.io/account/dashboard
         //https://api.weatherbit.io/v2.0/current?city=Chicago,IL&key=a708d5fe9c2141f493b8be489740df84
        function clearBox(elementID)
        {
            document.getElementById(elementID).innerHTML = "";
        }
         function ascii (a) { return String.fromCharCode(a); }
         
         
             window.mdc.autoInit();
             


        
      </script>
   </body>
</html>